{% extends "nepcore/base.html" %}

{% block js %}
	<script>
		app.run(['$state', function ($state) {
			$state.transitionTo('index');
		}])

		app.config(function($stateProvider, $urlRouterProvider, $interpolateProvider){
			$interpolateProvider.startSymbol('{[{').endSymbol('}]}');
			$stateProvider
				{% for state in state_manager.states %}
					.state('{{state.name}}', {
						url: '{{state.url}}',
						controller: function($templateCache){
							$templateCache.remove("{{state.link}}");
						},
						{% if state.params %}
						templateUrl: function($stateParams){
							return '{{state.link}}' + $stateParams.itemName
						}
						{% else %}
						templateUrl: '{{state.link}}',
						{% endif %}

					})
				{% endfor %}
		});

		app.factory('DynamicForm', function(){
			function DynamicFormInstance(index, formData={}){
				this.index = index;
				this.formData = formData;
				this.errors = {};
				this.lowerIndex = function(){
					this.index = this.index - 1;
				}
			};

			return {
				createNew: function(index, formData){
					return new DynamicFormInstance(index, formData);
				}
			};
		});

		app.directive("scroll", function ($window) {
			return function(scope, element, attrs) {
				angular.element($window).bind("scroll", function() {
					if (this.pageYOffset >= 50) {
						scope.navOffset = {'padding-top': "0px"}
						scope.$digest()
					} else {
						scope.navOffset = {'padding-top': (50 - this.pageYOffset).toString() + "px"}
						scope.$digest()
					}
				});
			};
		});

		app.controller('copyItemType', function($scope, $http) {
			// create a blank object to handle form data.
			$scope.fields = {};
			// calling our submit function.
			$scope.getItemTypeFields = function(url) {
				// Posting data as json
				$http({
					method: 'POST',
					url: "/nepcore/item/get/item-type-fields/",
					data: $scope.formData
					}).then(function successCallback(response) {
						$scope.fields = response.data;
					}, function errorCallback(response) {
					});
			};
		});

		app.controller('ListController', function($scope, $http) {
			$scope.pageToGet = 1;
			$scope.currentPage = 1;
			$scope.hasPrev = false;
			$scope.hasNext = false;

			$scope.prevPage = function(){
				$scope.getPage($scope.currentPage-1)
			}

			$scope.nextPage = function(){
				$scope.getPage($scope.currentPage+1)
			}

			$scope.getPage = function(page_number=1){
				// Posting data as json
				$http({
					method: 'POST',
					url: "/nepcore/auth/",
					data: {
						page: $scope.pageToGet,
						paginateBy: $scope.paginateBy
					},
					}).then(function successCallback(response) {
						$scope.currentPage = response.data.pageToGet
					}, function errorCallback(response) {
						console.log($scope.paginateBy)
						console.log("fail")
					});
				};
		});

		app.controller('postController', function($scope, $http) {
			// create a blank object to handle form data.
			$scope.formData = {};
			$scope.formErrors = {};
			// calling our submit function.
			$scope.submitForm = function(url) {
				// Posting data as json
				$http({
					method: 'POST',
					url: url,
					data: $scope.formData
					}).then(function successCallback(response) {
						$scope.formData = {};
						$scope.formErrors = {};
					}, function errorCallback(response) {
						$scope.formErrors = response.data;
					});
			};
		});

		app.controller('dynamicForms', function($scope, $http, DynamicForm) {
			// create a blank object to handle form data.
			// calling our submit function.
			$scope.getItemTypeFields = function(itemName) {
				// Posting data as json
				$http({
					method: 'POST',
					url: "/nepcore/item/get/item-type-fields/",
					data: {itemName: itemName}
					}).then(function successCallback(response) {
						// Potential bug if no fields are returned, forms will be cleared.
						// Minor issue though.
						fields = response.data;
						$scope.forms = [];
						$scope.count = 0
						console.log(fields);
						for (field in fields){
							$scope.addForm(fields[field]);
						};
					}, function errorCallback(response) {
					});
			};

			// This handles the forms html when adding and removing forms.
			$scope.forms = [DynamicForm.createNew(0)];
			$scope.count = 1
			$scope.removeForm = function(i){
				$scope.forms.splice(i, 1);
				forms = $scope.forms.slice(i)
				for (index in forms){
					forms[index].lowerIndex();
				};
				$scope.count = $scope.count - 1;
			};
			$scope.addForm = function(formData){
				$scope.forms.push(DynamicForm.createNew($scope.count, formData));
				$scope.count = $scope.count + 1;
			};

			// Submission of dynamic forms is a bit different to normal forms.
			// create a blank object to handle form data.
			$scope.formData = {};
			$scope.formErrors = {};

			// calling our submit function.
			$scope.submitForm = function(url) {
				// add the dynamic forms data to the global form data.
				$scope.formData.attributes = []
				for (index in $scope.forms){
					form = $scope.forms[index];
					form.formData.index = form.index;
					$scope.formData.attributes.push(form.formData);
				};
				// Posting data to django as json
				$http({
					method: 'POST',
					url: url,
					data: $scope.formData
					}).then(function successCallback(response) {
						$scope.formData = {};
						$scope.forms = [DynamicForm.createNew(0)];
						$scope.count = 1;
						$scope.formErrors = {};
					}, function errorCallback(response) {
						$scope.formErrors = response.data;
					});
			};
		});
	</script>
{% endblock %}

{% block body %}
	<body class="skin-black sidebar-mini" ng-app="NeptuneApp">
	<!-- <div class="wrapper"> -->

		<header class="main-header">
			<!-- Logo -->
			<a href="index2.html" class="logo">
				<!-- mini logo for sidebar mini 50x50 pixels -->
				<span class="logo-mini"><b>HG</b></span>
				<!-- logo for regular state and mobile devices -->
				<span class="logo-lg"><b>Hatfield Group</b></span>
			</a>
			<nav class="navbar navbar-static-top" role="navigation">
			  <!-- Sidebar toggle button-->
			  <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
				<span class="sr-only">Toggle navigation</span>
			  </a>
			  <div class="navbar-custom-menu">
				<ul class="nav navbar-nav">

					<li class="dropdown user user-menu">
						<a ng-href="#" 
						  <span class="hidden-xs">Welcome {{view.request.user}}
						</a>
					</li>
					<li class="dropdown user user-menu">
						<a ng-href="/nepcore/logout/" 
						  <span class="hidden-xs">Logout
						</a>
					</li>
					<li class="dropdown user user-menu">
						<a ng-href="#">  <span class="hidden-xs">Powered by Neptune</span></a>
					</li>

				  </ul>
			  </div>
			</nav>
		</header>
		<!-- </div> -->
		{% block menu %}
			<aside class="main-sidebar" scroll ng-style="navOffset" style="position: fixed">
				<!-- sidebar: style can be found in sidebar.less -->
				<section class="sidebar">
					{% autoescape off %}{{menu.render}}{% endautoescape on %}
				</section>
			</aside>
		{% endblock %}
		<!-- <div class="content-wrapper"> -->
		<div class="content-wrapper" ui-view>
			{% block content %}
			{% endblock %}
		</div>
		<!-- </div> -->
	</body>

	{% block extra_js %}
	{% endblock %}
{% endblock body %}